<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Espace Famille - Casa Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="shortcut icon" href="../assets/images/logo_casahome.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #2AA4CD;
      --primary-orange: #EB6F27;
      --light-blue: #E6F4F9;
      --dark-blue: #1A7A9A;
      --light-orange: #FFF4ED;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      color: #333;
      line-height: 1.6;
    }
    
    .navbar-branding {
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .navbar-brand img {
      height: 48px;
    }
    
    .nav-link {
      font-weight: 500;
      color: #555 !important;
      transition: all 0.2s;
    }
    
    .nav-link:hover {
      color: var(--primary-blue) !important;
    }
    
    .nav-link.active {
      color: var(--primary-blue) !important;
      font-weight: 600;
    }
    
    .btn-primary {
      background-color: var(--primary-orange);
      border-color: var(--primary-orange);
      color: white;
      font-weight: 500;
      padding: 8px 16px;
      box-shadow: 0 2px 8px rgba(235, 111, 39, 0.3);
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      background-color: #D96523;
      border-color: #D96523;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(235, 111, 39, 0.4);
    }
    
    .btn-outline-primary {
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      font-weight: 500;
    }
    
    .btn-outline-primary:hover {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .section-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.3s;
    }
    
    .section-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      border-left: 4px solid var(--primary-blue);
      padding-left: 12px;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    
    .required::after {
      content: " *";
      color: #dc3545;
    }
    
    .form-control, .form-select {
      padding: 10px 12px;
      border-radius: 8px;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 0.25rem rgba(42, 164, 205, 0.25);
    }
    
    .help-card {
      background-color: var(--light-blue);
      border-radius: 12px;
      padding: 1.5rem;
      height: 100%;
    }
    
    .help-card h2 {
      font-size: 1rem;
      text-transform: uppercase;
      color: var(--dark-blue);
      margin-bottom: 1.5rem;
    }
    
    .help-card .btn-light {
      background-color: white;
      border-radius: 8px;
      padding: 10px 15px;
      text-align: left;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .help-card .btn-light:hover {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .help-card .btn-light i {
      margin-right: 8px;
      color: var(--primary-blue);
    }
    
    .help-card .btn-light:hover i {
      color: white;
    }
    
    .preview-card {
      border: 1px dashed var(--primary-blue);
      border-radius: 12px;
      padding: 1.5rem;
      background-color: rgba(42, 164, 205, 0.05);
    }
    
    .preview-card h3 {
      font-size: 1.1rem;
      color: var(--dark-blue);
      margin-bottom: 1rem;
    }
    
    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .file-upload-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .site-footer {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .site-footer a {
      color: white;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .site-footer a:hover {
      text-decoration: underline;
      opacity: 0.9;
    }
    
    @media (max-width: 768px) {
      .section-title {
        font-size: 1.2rem;
      }
    }
  </style>
  <!-- Simple demo-only persistence -->
  <script>
    // Access guard: only 'family' role can view this page
    (function(){
      try {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const role = localStorage.getItem('userRole');
        
        if (!isLoggedIn || !role) {
          alert('Vous devez être connecté pour accéder à cette page.');
          window.location.replace('../login.html');
          return;
        }
        
        if (role !== 'family') {
          alert('Accès refusé. Cette page est réservée aux familles d\'accueil. Veuillez vous connecter avec un compte famille.');
          window.location.replace('../login.html');
          return;
        }
      } catch(e) {
        console.error('Erreur lors de la vérification des permissions:', e);
        alert('Erreur lors de la vérification des permissions. Veuillez vous reconnecter.');
        window.location.replace('../login.html');
      }
    })();
    
    function saveFormToLocalStorage(formId, storageKey){
      const form = document.getElementById(formId);
      const data = new FormData(form);
      const json = {};
      for (const [k,v] of data.entries()) json[k] = v;
      localStorage.setItem(storageKey, JSON.stringify(json));
      return json;
    }
    
    function loadFormFromLocalStorage(formId, storageKey){
      const raw = localStorage.getItem(storageKey); if(!raw) return;
      const data = JSON.parse(raw);
      const form = document.getElementById(formId);
      Object.keys(data).forEach(k=>{ if(form.elements[k]) form.elements[k].value = data[k]; });
    }
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-branding sticky-top">
    <div class="container">
      <a class="navbar-brand" href="../../index.html">
        <img src="../assets/images/logo_casahome.png" alt="Casa Home">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" href="familles.html">Espace Famille</a></li>
        </ul>
        <div class="d-flex align-items-center">
          <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="../assets/images/user-avatar.jpg" alt="Profil" width="32" height="32" class="rounded-circle me-2">
              <span class="d-none d-sm-inline">Mon compte</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser">
              <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profil</a></li>
              <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>Paramètres</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-1">Espace Famille</h1>
        <p class="text-muted mb-0">Gérez votre profil et vos annonces d'accueil</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="loadFormFromLocalStorage('formProfil','profilFamille');loadFormFromLocalStorage('formHebergement','hebergementFamille');loadFormFromLocalStorage('formDisponibilites','disponibilitesFamille');">
          <i class="bi bi-arrow-clockwise me-1"></i>Charger brouillon
        </button>
        <a href="../families.html" class="btn btn-primary" target="_blank">
          <i class="bi bi-eye me-1"></i>Voir mon annonce
        </a>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <!-- Profil de la famille -->
        <div class="card section-card mb-4">
          <div class="card-body">
            <h2 class="section-title">Profil de la famille</h2>
            <form id="formProfil" class="row g-3">
              <div class="col-md-6">
                <label class="form-label required">Nom de famille</label>
                <input type="text" class="form-control" name="nomFamille" placeholder="Ex: Famille Diatta" required>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Localisation</label>
                <input type="text" class="form-control" name="localisation" placeholder="Ville / Village" required>
              </div>
              <div class="col-12">
                <label class="form-label">Présentation</label>
                <textarea class="form-control" rows="4" name="presentation" placeholder="Décrivez votre famille et votre accueil"></textarea>
                <div class="form-text">Cette description apparaîtra sur votre annonce publique.</div>
              </div>
              <div class="col-12 d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="saveFormToLocalStorage('formProfil','profilFamille');this.blur();">
                  <i class="bi bi-save me-1"></i>Enregistrer
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Hébergement -->
        <div class="card section-card mb-4">
          <div class="card-body">
            <h2 class="section-title">Hébergement</h2>
            <form id="formHebergement" class="row g-3">
              <div class="col-md-4">
                <label class="form-label required">Capacité (personnes)</label>
                <input type="number" min="1" class="form-control" name="capacite" required>
              </div>
              <div class="col-md-8">
                <label class="form-label">Équipements</label>
                <input type="text" class="form-control" name="equipements" placeholder="Wi-Fi, Climatisation, Salle de bain privée...">
              </div>
              <div class="col-12">
                <label class="form-label">Activités proposées</label>
                <input type="text" class="form-control" name="activites" placeholder="Cuisine locale, Visite village, Atelier artisanat...">
              </div>
              <div class="col-12 d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="saveFormToLocalStorage('formHebergement','hebergementFamille');this.blur();">
                  <i class="bi bi-save me-1"></i>Enregistrer
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Disponibilités et tarifs -->
        <div class="card section-card mb-4">
          <div class="card-body">
            <h2 class="section-title">Disponibilités et tarifs</h2>
            <form id="formDisponibilites" class="row g-3">
              <div class="col-md-6">
                <label class="form-label required">Disponible à partir de</label>
                <input type="date" class="form-control" name="dateDebut" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Jusqu'au</label>
                <input type="date" class="form-control" name="dateFin">
              </div>
              <div class="col-md-6">
                <label class="form-label required">Tarif / journée (FCFA)</label>
                <input type="number" min="0" class="form-control" name="tarif" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Conditions</label>
                <input type="text" class="form-control" name="conditions" placeholder="Petit-déjeuner inclus, etc.">
              </div>
              <div class="col-12 d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="saveFormToLocalStorage('formDisponibilites','disponibilitesFamille');this.blur();">
                  <i class="bi bi-save me-1"></i>Enregistrer
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Photos -->
        <div class="card section-card mb-4">
          <div class="card-body">
            <h2 class="section-title">Photos</h2>
            <form id="formPhotos" class="row g-3" enctype="multipart/form-data">
              <div class="col-12">
                <div class="file-upload btn btn-light w-100 py-3">
                  <i class="bi bi-cloud-arrow-up me-2"></i>Choisir des photos
                  <input type="file" class="file-upload-input" name="photos[]" id="photos" multiple accept="image/png,image/jpeg">
                </div>
                <div id="fileList" class="mt-2 small text-muted">Aucun fichier sélectionné</div>
                <div class="form-text">Téléversez quelques photos de votre hébergement (JPG/PNG, max 5Mo par image).</div>
              </div>
              <div class="col-12">
                <div class="preview-card">
                  <h3>Aperçu de votre annonce</h3>
                  <p class="text-muted small">Voici comment votre annonce apparaîtra aux visiteurs :</p>
                  <div class="d-flex align-items-center bg-light p-3 rounded">
                    <div class="bg-secondary" style="width: 100px; height: 70px; border-radius: 6px;"></div>
                    <div class="ms-3">
                      <div class="placeholder-glow">
                        <span class="placeholder col-6"></span>
                      </div>
                      <div class="placeholder-glow">
                        <span class="placeholder col-4"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="uploadBtn">
                  <i class="bi bi-upload me-1"></i>Téléverser
                </button>
                <button type="button" class="btn btn-primary" id="publishBtn">
                  <i class="bi bi-check-circle me-1"></i>Publier l'annonce
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Réservations reçues -->
      <div class="card section-card mb-4">
        <div class="card-body">
          <h2 class="section-title">Réservations reçues</h2>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Touriste</th>
                  <th>Période</th>
                  <th>Personnes</th>
                  <th>Prix total</th>
                  <th>Statut</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="familyReservationsBody">
                <!-- Rempli dynamiquement -->
              </tbody>
            </table>
          </div>
          
          <div class="text-center text-muted py-3" id="noReservationsMessage">
            <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
            <p class="mt-2">Aucune réservation reçue pour le moment</p>
            <small>Les réservations apparaîtront ici quand des touristes réserveront chez vous</small>
          </div>
        </div>
      </div>
      
      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="help-card">
          <h2><i class="bi bi-question-circle me-2"></i>Aide & Raccourcis</h2>
          <div class="d-grid gap-2">
            <a class="btn btn-light" href="../families.html">
              <i class="bi bi-people"></i>Voir les familles en ligne
            </a>
            <a class="btn btn-light" href="touristes.html">
              <i class="bi bi-list-check"></i>Suivi des réservations
            </a>
            <a class="btn btn-light" href="admin.html">
              <i class="bi bi-shield-check"></i>Validations (admin)
            </a>
            <a class="btn btn-light" href="../contact.html">
              <i class="bi bi-headset"></i>Support technique
            </a>
          </div>
          
          <hr class="my-3">
          
          <h2><i class="bi bi-lightbulb me-2"></i>Conseils</h2>
          <div class="alert alert-light small">
            <i class="bi bi-info-circle text-primary me-2"></i>
            Remplissez tous les champs obligatoires pour publier votre annonce.
          </div>
          <div class="alert alert-light small">
            <i class="bi bi-info-circle text-primary me-2"></i>
            Ajoutez des photos de qualité pour attirer plus de visiteurs.
          </div>
          
          <hr class="my-3">
          
          <h2><i class="bi bi-floppy me-2"></i>Brouillons</h2>
          <p class="small text-muted mb-2">Vos brouillons sont enregistrés localement dans votre navigateur.</p>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="loadFormFromLocalStorage('formProfil','profilFamille');loadFormFromLocalStorage('formHebergement','hebergementFamille');loadFormFromLocalStorage('formDisponibilites','disponibilitesFamille');">
              <i class="bi bi-arrow-clockwise me-1"></i>Charger
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="localStorage.removeItem('profilFamille');localStorage.removeItem('hebergementFamille');localStorage.removeItem('disponibilitesFamille');alert('Brouillons supprimés.');">
              <i class="bi bi-trash me-1"></i>Effacer
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer mt-5">
    <div class="container py-4 d-flex flex-column flex-md-row align-items-center justify-content-between">
      <div>&copy; <span id="year"></span> Casa Home. Tous droits réservés.</div>
      <div class="d-flex gap-3 mt-3 mt-md-0">
        <a class="text-white text-decoration-none" href="../index.html">Accueil</a>
        <a class="text-white text-decoration-none" href="../contact.html">Contact</a>
        <a class="text-white text-decoration-none" href="../privacy.html">Confidentialité</a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Année courante
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Afficher les fichiers sélectionnés
    document.getElementById('photos').addEventListener('change', function(e) {
      const files = e.target.files;
      const fileList = document.getElementById('fileList');
      
      if (files.length === 0) {
        fileList.textContent = 'Aucun fichier sélectionné';
        return;
      }
      
      let html = '';
      for (let i = 0; i < Math.min(files.length, 3); i++) {
        html += `<div>${files[i].name} (${(files[i].size / 1024 / 1024).toFixed(2)} Mo)</div>`;
      }
      
      if (files.length > 3) {
        html += `<div>+ ${files.length - 3} autres fichiers</div>`;
      }
      
      fileList.innerHTML = html;
    });
    
    // Helpers for listings
    function readListings(){
      try { return JSON.parse(localStorage.getItem('familyListings') || '[]'); } catch(e){ return []; }
    }
    
    function saveListings(list){
      try { localStorage.setItem('familyListings', JSON.stringify(list)); } catch(e){}
    }
    
    function getCurrentUser(){
      try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; }
    }
    
    function collectFormData(){
      const profil = new FormData(document.getElementById('formProfil'));
      const heb = new FormData(document.getElementById('formHebergement'));
      const disp = new FormData(document.getElementById('formDisponibilites'));
      const data = {
        nomFamille: profil.get('nomFamille')?.trim(),
        localisation: profil.get('localisation')?.trim(),
        presentation: profil.get('presentation')?.trim() || '',
        capacite: heb.get('capacite') ? parseInt(heb.get('capacite'),10) : null,
        equipements: heb.get('equipements')?.trim() || '',
        activites: heb.get('activites')?.trim() || '',
        dateDebut: disp.get('dateDebut') || '',
        dateFin: disp.get('dateFin') || '',
        tarif: disp.get('tarif') ? parseInt(disp.get('tarif'),10) : null,
        conditions: disp.get('conditions')?.trim() || ''
      };
      return data;
    }
    
    function validateData(d){
      if(!d.nomFamille) return 'Nom de famille requis';
      if(!d.localisation) return 'Localisation requise';
      if(!d.capacite || d.capacite < 1) return 'Capacité invalide';
      if(!d.tarif || d.tarif < 0) return 'Tarif invalide';
      if(!d.dateDebut) return 'Date de disponibilité requise';
      return '';
    }
    
    function buildPayload(){
      const user = getCurrentUser();
      const data = collectFormData();
      const err = validateData(data);
      if(err){ return { error: err }; }
      const listing = {
        id: Date.now(),
        ownerEmail: user?.email || null,
        rating: 0, 
        reviews: 0,
        ...data
      };
      return { listing, user };
    }

    async function uploadToServer(includePhotos){
      const payload = buildPayload();
      if(payload.error){ alert(payload.error); return; }
      const { listing, user } = payload;
      const form = new FormData();
      
      Object.keys(listing).forEach(k => {
        if (listing[k] !== null && listing[k] !== undefined) form.append(k, listing[k]);
      });
      
      if (includePhotos) {
        const files = document.getElementById('photos').files;
        for (let i=0;i<files.length;i++) form.append('photos[]', files[i]);
      }
      
      try {
        // Simulation d'envoi au serveur
        console.log('Envoi des données au serveur...', listing);
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Enregistrement local pour la démo
        const list = readListings();
        const idx = list.findIndex(x => user && x.ownerEmail && x.ownerEmail === user.email);
        
        const firstImage = includePhotos && document.getElementById('photos').files.length > 0 ? 
          URL.createObjectURL(document.getElementById('photos').files[0]) : 
          '../public/assets/images/placeholder.jpg';
        
        const local = { 
          ...listing, 
          image: firstImage,
          isNew: true
        };
        
        if(idx >= 0){ 
          list[idx] = { ...list[idx], ...local }; 
        } else { 
          list.push(local); 
        }
        
        saveListings(list);
        alert('Votre annonce a été publiée avec succès !');
        
      } catch (e) {
        console.error(e);
        alert('Échec de publication: ' + (e.message || 'Erreur inconnue'));
      }
    }

    // Fonction pour publier une annonce
function publishFamily() {
  // Récupérer les données des formulaires
  const profilForm = document.getElementById('formProfil');
  const hebergementForm = document.getElementById('formHebergement');
  const disponibilitesForm = document.getElementById('formDisponibilites');
  
  // Récupérer les fichiers images
  const photoInput = document.getElementById('photos');
  const photos = photoInput.files;
  const imageNames = [];
  
  // Simuler l'upload des images (dans un vrai projet, vous utiliseriez FormData et fetch)
  if (photos.length > 0) {
    for (let i = 0; i < photos.length; i++) {
      const fileName = `family_${Date.now()}_${i}.${photos[i].name.split('.').pop()}`;
      imageNames.push(fileName);
    }
  } else {
    imageNames.push('placeholder.jpg');
  }
  
  const familyData = {
    id: Date.now(),
    nomFamille: profilForm.querySelector('[name="nomFamille"]').value,
    localisation: profilForm.querySelector('[name="localisation"]').value,
    presentation: profilForm.querySelector('[name="presentation"]').value,
    capacite: parseInt(hebergementForm.querySelector('[name="capacite"]').value),
    equipements: hebergementForm.querySelector('[name="equipements"]').value,
    activites: hebergementForm.querySelector('[name="activites"]').value,
    dateDebut: disponibilitesForm.querySelector('[name="dateDebut"]').value,
    dateFin: disponibilitesForm.querySelector('[name="dateFin"]').value,
    tarif: parseInt(disponibilitesForm.querySelector('[name="tarif"]').value),
    conditions: disponibilitesForm.querySelector('[name="conditions"]').value,
    images: imageNames,
    rating: 0,
    reviews: 0,
    isNew: true
  };

  // Validation
  if (!familyData.nomFamille || !familyData.localisation || !familyData.capacite || 
      !familyData.tarif || !familyData.dateDebut) {
    alert('Veuillez remplir tous les champs obligatoires (marqués d\'un *) avant de publier.');
    return;
  }
  
  // Récupérer les annonces existantes
  let existingFamilies = JSON.parse(localStorage.getItem('familyListings')) || [];
  
  // Ajouter la nouvelle annonce
  existingFamilies.push(familyData);
  
  // Sauvegarder
  localStorage.setItem('familyListings', JSON.stringify(existingFamilies));
  
  // Dans un vrai projet, vous enverriez les données au serveur ici
  // avec FormData pour gérer les fichiers
  
  alert('Annonce publiée avec succès !');
  setTimeout(() => {
    window.location.href = '../families.html';
  }, 1500);
}
    document.getElementById('publishBtn').addEventListener('click', publishFamily);
    document.getElementById('uploadBtn').addEventListener('click', function(){ uploadToServer(true); });
    
    // Fonctions pour les réservations
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }
    
    function badgeFor(status) {
      const badges = {
        'pending': '<span class="badge bg-warning">En attente</span>',
        'confirmed': '<span class="badge bg-success">Confirmée</span>',
        'cancelled': '<span class="badge bg-danger">Annulée</span>',
        'completed': '<span class="badge bg-info">Terminée</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">Inconnu</span>';
    }
    
    function loadFamilyReservations() {
      const body = document.getElementById('familyReservationsBody');
      const noReservationsMessage = document.getElementById('noReservationsMessage');
      
      // Récupérer les réservations depuis localStorage
      const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
      
      // Filtrer les réservations pour cette famille (par nom de famille)
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      const familyName = currentUser.nom || 'Famille';
      
      const familyReservations = reservations.filter(r => 
        r.familyName && r.familyName.includes(familyName)
      );
      
      if (familyReservations.length === 0) {
        body.innerHTML = '';
        noReservationsMessage.style.display = 'block';
      } else {
        noReservationsMessage.style.display = 'none';
        body.innerHTML = '';
        
        familyReservations.forEach(r => {
          body.insertAdjacentHTML('beforeend', `
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
                  <div>
                    <div class="fw-medium">Touriste</div>
                    <small class="text-muted">${r.createdAt ? formatDate(r.createdAt) : 'Date inconnue'}</small>
                  </div>
                </div>
              </td>
              <td><i class="bi bi-calendar3 me-1"></i>${formatDate(r.checkIn)} → ${formatDate(r.checkOut)}</td>
              <td>${r.guests} personne${r.guests > 1 ? 's' : ''}</td>
              <td>${r.totalPrice}</td>
              <td>${badgeFor(r.status)}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="showReservationDetails(${r.id})">
                  <i class="bi bi-eye"></i>
                </button>
                ${r.status === 'pending' ? `
                  <button class="btn btn-sm btn-success me-2" onclick="acceptReservation(${r.id})">
                    <i class="bi bi-check"></i> Accepter
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="rejectReservation(${r.id})">
                    <i class="bi bi-x"></i> Refuser
                  </button>
                ` : ''}
                ${r.status === 'confirmed' ? `
                  <button class="btn btn-sm btn-info" onclick="markAsCompleted(${r.id})">
                    <i class="bi bi-check-circle"></i> Terminer
                  </button>
                ` : ''}
              </td>
            </tr>
          `);
        });
      }
    }
    
    function showReservationDetails(id) {
      const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
      const res = reservations.find(r => r.id === id);
      if (res) {
        alert(`Détails de la réservation\n\nTouriste: ${res.familyName}\nPériode: ${formatDate(res.checkIn)} au ${formatDate(res.checkOut)}\nPersonnes: ${res.guests}\nStatut: ${res.status}\nPrix: ${res.totalPrice}\nMessage: ${res.message || 'Aucun message'}`);
      }
    }
    
    function acceptReservation(id) {
      if (confirm('Êtes-vous sûr de vouloir accepter cette réservation ?')) {
        const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
        const res = reservations.find(r => r.id === id);
        if (res) {
          res.status = 'confirmed';
          localStorage.setItem('reservations', JSON.stringify(reservations));
          loadFamilyReservations();
          alert('Réservation acceptée ! Le touriste sera notifié.');
        }
      }
    }
    
    function rejectReservation(id) {
      if (confirm('Êtes-vous sûr de vouloir refuser cette réservation ?')) {
        const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
        const res = reservations.find(r => r.id === id);
        if (res) {
          res.status = 'cancelled';
          localStorage.setItem('reservations', JSON.stringify(reservations));
          loadFamilyReservations();
          alert('Réservation refusée.');
        }
      }
    }
    
    function markAsCompleted(id) {
      if (confirm('Marquer cette réservation comme terminée ?')) {
        const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
        const res = reservations.find(r => r.id === id);
        if (res) {
          res.status = 'completed';
          localStorage.setItem('reservations', JSON.stringify(reservations));
          loadFamilyReservations();
          alert('Réservation marquée comme terminée.');
        }
      }
    }
    
    // Gestion de la déconnexion
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
        // Nettoyer toutes les données de session
        localStorage.removeItem('userRole');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('currentUser');
        window.location.href = '../login.html';
      }
    });
    
    // Charger les réservations au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      loadFamilyReservations();
    });
  </script>
</body>
</html>