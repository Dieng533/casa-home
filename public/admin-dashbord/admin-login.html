<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion Administrateur - Casa Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="shortcut icon" href="../assets/images/logo_casahome.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #2AA4CD;
      --primary-orange: #EB6F27;
      --light-blue: #E6F4F9;
      --dark-blue: #1A7A9A;
      --admin-dark: #2c3e50;
      --admin-accent: #e74c3c;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--admin-dark) 0%, #34495e 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .admin-login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      width: 100%;
      max-width: 450px;
      position: relative;
    }
    
    .admin-login-header {
      background: linear-gradient(135deg, var(--admin-dark) 0%, var(--admin-accent) 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .admin-login-header img {
      height: 60px;
      margin-bottom: 1rem;
    }
    
    .admin-login-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .admin-login-header p {
      opacity: 0.9;
      margin: 0;
    }
    
    .admin-login-body {
      padding: 2rem;
    }
    
    .form-floating {
      margin-bottom: 1.5rem;
    }
    
    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: var(--admin-accent);
      box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
    }
    
    .btn-admin {
      background: linear-gradient(135deg, var(--admin-accent) 0%, #c0392b 100%);
      border: none;
      border-radius: 10px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      color: white;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .btn-admin:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
      color: white;
    }
    
    .btn-admin:disabled {
      opacity: 0.7;
      transform: none;
    }
    
    .alert {
      border-radius: 10px;
      border: none;
      margin-bottom: 1.5rem;
    }
    
    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .back-link {
      text-align: center;
      margin-top: 1.5rem;
    }
    
    .back-link a {
      color: var(--admin-dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    
    .back-link a:hover {
      color: var(--admin-accent);
    }
    
    .security-notice {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #856404;
    }
    
    .security-notice i {
      color: var(--admin-accent);
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="admin-login-container">
    <div class="admin-login-header">
      <img src="../assets/images/logo_casahome.png" alt="Casa Home">
      <h1>Administration</h1>
      <p>Accès sécurisé au panneau d'administration</p>
    </div>
    
    <div class="admin-login-body">
      <div class="security-notice">
        <i class="bi bi-shield-lock"></i>
        <strong>Sécurité :</strong> Cette zone est réservée aux administrateurs autorisés uniquement.
      </div>
      
      <!-- Message d'erreur -->
      <div class="alert alert-danger d-none" id="errorMessage" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorText">Erreur de connexion</span>
      </div>
      
      <form id="adminLoginForm">
        <div class="form-floating">
          <input type="email" class="form-control" id="adminEmail" placeholder="admin@casahome.com" required>
          <label for="adminEmail">Email administrateur</label>
        </div>
        
        <div class="form-floating">
          <input type="password" class="form-control" id="adminPassword" placeholder="Mot de passe" required>
          <label for="adminPassword">Mot de passe</label>
        </div>
        
        <button type="submit" class="btn btn-admin" id="adminLoginBtn">
          <span id="adminLoginBtnText">Se connecter</span>
          <span class="spinner-border spinner-border-sm d-none" id="adminLoginBtnSpinner" role="status"></span>
        </button>
      </form>
      
      <div class="back-link">
        <a href="../login.html">
          <i class="bi bi-arrow-left me-1"></i>
          Retour à la connexion utilisateur
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Vérifier si l'utilisateur est déjà connecté comme admin
    (function() {
      try {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const role = localStorage.getItem('userRole');
        
        if (isLoggedIn && role === 'admin') {
          window.location.href = 'admin.html';
        }
      } catch(e) {
        console.error('Erreur lors de la vérification de connexion:', e);
      }
    })();
    
    // Fonctions utilitaires
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      errorDiv.classList.remove('d-none');
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function hideError() {
      document.getElementById('errorMessage').classList.add('d-none');
    }
    
    function setLoading(loading) {
      const btn = document.getElementById('adminLoginBtn');
      const btnText = document.getElementById('adminLoginBtnText');
      const spinner = document.getElementById('adminLoginBtnSpinner');
      
      if (loading) {
        btn.disabled = true;
        btnText.textContent = 'Connexion en cours...';
        spinner.classList.remove('d-none');
      } else {
        btn.disabled = false;
        btnText.textContent = 'Se connecter';
        spinner.classList.add('d-none');
      }
    }
    
    // Fonctions de gestion des administrateurs
    async function adminLogin(email, password) {
      try {
        const response = await fetch('../api/admin-auth.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'login',
            email: email,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Erreur de connexion');
        }
        
        return data;
      } catch (error) {
        console.error('Erreur API admin:', error);
        // Fallback vers la méthode locale
        return await localAdminLogin(email, password);
      }
    }
    
    // Fallback local si l'API n'est pas disponible
    async function localAdminLogin(email, password) {
      try {
        const response = await fetch('../data/admin_users.json');
        if (!response.ok) {
          throw new Error('Impossible de charger les données administrateurs');
        }
        const data = await response.json();
        const admins = data.admins || [];
        
        const admin = admins.find(admin => 
          (admin.email || '').toLowerCase() === email.toLowerCase()
        );
        
        if (!admin) {
          throw new Error('Aucun compte administrateur trouvé');
        }
        
        if (admin.status !== 'active') {
          throw new Error('Ce compte administrateur est désactivé');
        }
        
        if (admin.password !== password) {
          throw new Error('Mot de passe incorrect');
        }
        
        // Retourner les données de l'admin (sans le mot de passe)
        const adminData = { ...admin };
        delete adminData.password;
        
        return {
          success: true,
          admin: adminData,
          message: 'Connexion réussie (mode local)'
        };
      } catch (error) {
        throw new Error(error.message || 'Erreur de connexion locale');
      }
    }
    
    function setCurrentUser(user) {
      try {
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.setItem('userRole', user.role);
        localStorage.setItem('isLoggedIn', 'true');
      } catch(e) {
        console.error('Erreur lors de la sauvegarde de l\'utilisateur:', e);
      }
    }
    
    // Fonction pour lire les utilisateurs locaux (fallback)
    function readLocalUsers() {
      try { 
        return JSON.parse(localStorage.getItem('users') || '[]'); 
      } catch(e) { 
        return []; 
      }
    }
    
    // Initialiser les utilisateurs de test si nécessaire (fallback)
    function initializeTestUsers() {
      const users = readLocalUsers();
      if (users.length === 0) {
        const testUsers = [
          {
            id: 1,
            email: 'touriste@test.com',
            password: 'password123',
            role: 'tourist',
            nom: 'Jean Dupont',
            prenom: 'Jean'
          },
          {
            id: 2,
            email: 'famille@test.com',
            password: 'password123',
            role: 'family',
            nom: 'Famille Diatta',
            prenom: 'Mariama'
          },
          {
            id: 3,
            email: 'admin@test.com',
            password: 'admin123',
            role: 'admin',
            nom: 'Admin',
            prenom: 'Administrateur'
          }
        ];
        
        try {
          localStorage.setItem('users', JSON.stringify(testUsers));
          console.log('Utilisateurs de test initialisés (fallback)');
        } catch (e) {
          console.error('Erreur lors de l\'initialisation des utilisateurs de test:', e);
        }
      }
    }
    
    // Initialiser les utilisateurs de test (fallback uniquement)
    initializeTestUsers();
    
    // Gestion de la soumission du formulaire
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      hideError();
      
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      
      // Validation des champs
      if (!email || !password) {
        showError('Veuillez remplir tous les champs obligatoires.');
        return;
      }
      
      if (!email.includes('@')) {
        showError('Veuillez saisir une adresse email valide.');
        return;
      }
      
      setLoading(true);
      
      try {
        // Authentification via API ou fallback local
        const result = await adminLogin(email, password);
        
        if (!result.success) {
          showError(result.error || 'Erreur de connexion');
          return;
        }
        
        const admin = result.admin;
        
        // Vérifier que c'est bien un compte admin
        if (admin.role !== 'admin') {
          showError('Accès refusé. Ce compte n\'a pas les privilèges d\'administrateur.');
          return;
        }
        
        // Connexion réussie
        setCurrentUser(admin);
        
        // Log de connexion
        console.log(`Connexion admin: ${admin.email} - Permissions: ${(admin.permissions || []).join(', ')}`);
        
        // Redirection vers le panneau admin
        window.location.href = 'admin.html';
        
      } catch (error) {
        console.error('Erreur de connexion admin:', error);
        showError(error.message || 'Erreur de connexion. Veuillez réessayer ou contacter le support.');
      } finally {
        setLoading(false);
      }
    });
    
    // Masquer l'erreur quand l'utilisateur commence à taper
    document.getElementById('adminEmail').addEventListener('input', hideError);
    document.getElementById('adminPassword').addEventListener('input', hideError);
  </script>
</body>
</html>
