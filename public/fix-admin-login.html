<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Correction Connexion Admin - Casa Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 20px; background: #f8f9fa; }
    .login-form { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-form">
      <h2 class="text-center mb-4">Connexion Admin</h2>
      
      <form id="adminLoginForm">
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" value="admin@casahome.com" required>
        </div>
        
        <div class="mb-3">
          <label for="password" class="form-label">Mot de passe</label>
          <input type="password" class="form-control" id="password" value="admin123" required>
        </div>
        
        <button type="submit" class="btn btn-primary w-100">Se connecter</button>
      </form>
      
      <div id="result"></div>
      
      <div class="mt-4">
        <h5>Comptes de test disponibles :</h5>
        <ul class="list-unstyled">
          <li><strong>Admin Principal:</strong> admin@casahome.com / admin123</li>
          <li><strong>Super Admin:</strong> superadmin@casahome.com / superadmin2024</li>
          <li><strong>Modérateur:</strong> moderateur@casahome.com / moderateur123</li>
          <li><strong>Support:</strong> support@casahome.com / support123</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('result');
      
      resultDiv.innerHTML = '<div class="result">Connexion en cours...</div>';
      
      try {
        // Test 1: Vérifier si le fichier JSON existe
        const jsonResponse = await fetch('data/admin_users.json');
        if (!jsonResponse.ok) {
          throw new Error('Fichier admin_users.json non trouvé');
        }
        
        const data = await jsonResponse.json();
        console.log('Données JSON chargées:', data);
        
        // Test 2: Chercher l'administrateur
        const admin = data.admins.find(a => a.email.toLowerCase() === email.toLowerCase());
        
        if (!admin) {
          throw new Error('Aucun administrateur trouvé avec cet email');
        }
        
        console.log('Admin trouvé:', admin);
        
        // Test 3: Vérifier le statut
        if (admin.status !== 'active') {
          throw new Error(`Compte désactivé: ${admin.status}`);
        }
        
        // Test 4: Vérifier le mot de passe
        if (admin.password !== password) {
          throw new Error('Mot de passe incorrect');
        }
        
        // Connexion réussie
        const adminData = { ...admin };
        delete adminData.password;
        
        // Sauvegarder en localStorage
        localStorage.setItem('currentUser', JSON.stringify(adminData));
        localStorage.setItem('userRole', adminData.role);
        localStorage.setItem('isLoggedIn', 'true');
        
        resultDiv.innerHTML = `
          <div class="result success">
            ✅ Connexion réussie!<br>
            Bienvenue ${adminData.nom} ${adminData.prenom}<br>
            Permissions: ${adminData.permissions.join(', ')}<br>
            <a href="admin-dashbord/admin.html" class="btn btn-success btn-sm mt-2">Accéder au panneau admin</a>
          </div>
        `;
        
        console.log('Connexion réussie:', adminData);
        
      } catch (error) {
        console.error('Erreur de connexion:', error);
        resultDiv.innerHTML = `
          <div class="result error">
            ❌ Erreur: ${error.message}
          </div>
        `;
      }
    });
    
    // Test automatique au chargement
    window.addEventListener('load', function() {
      console.log('Page de correction chargée');
      console.log('localStorage actuel:', {
        currentUser: localStorage.getItem('currentUser'),
        userRole: localStorage.getItem('userRole'),
        isLoggedIn: localStorage.getItem('isLoggedIn')
      });
    });
  </script>
</body>
</html>
